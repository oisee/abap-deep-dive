# Патч для важных исправлений Главы 7.1 (Приложение)
# Дата: 2025-07-21
# Применить с помощью скрипта apply_patches.py

## ВАЖНЫЕ ИСПРАВЛЕНИЯ

### Исправление 13: Добавить недостающие протоколы
- Файл: ADD - Глава 7 Приложение Протоколы SAP - открытость и внутреннее устройство.md
- Строка: в конце документа
- Добавить:
```
## Дополнительные протоколы SAP

### SAPRouter Protocol
- Назначение: Сетевая маршрутизация и безопасность
- Порт: 3299 (по умолчанию)
- Особенности: Поддержка route strings, SNC integration

### P4 Protocol
- Назначение: Мониторинг производительности
- Используется: Solution Manager, EarlyWatch
- Порт: Динамический

### NI (Network Interface) Protocol
- Назначение: Низкоуровневый сетевой слой SAP
- Особенности: Основа для всех высокоуровневых протоколов
- Поддержка: IPv4/IPv6, keep-alive, large packets

### CPIC (Common Programming Interface for Communications)
- Назначение: Основа для RFC
- Стандарт: IBM CPI-C compatible
- Особенности: Синхронная коммуникация
```
- Причина: Важные протоколы отсутствуют

### Исправление 14: Добавить примеры бинарных форматов
- Файл: ADD - Глава 7 Приложение Протоколы SAP - открытость и внутреннее устройство.md
- Строка: после описания каждого протокола
- Добавить:
```
### Пример бинарного формата DIAG (hex dump)

```
00000000: 00 14 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00000010: 10 04 02 00 04 00 00 00  44 49 41 47 ...
          |----header----| |type| |--payload--|
```

- Offset 0-1: Длина пакета
- Offset 2: Версия протокола
- Offset 3: Тип сообщения
- Offset 4+: Данные

Примечание: Реальный формат проприетарный
```
- Причина: Отсутствуют примеры бинарных форматов

### Исправление 15: Добавить информацию о безопасности
- Файл: ADD - Глава 7 Приложение Протоколы SAP - открытость и внутреннее устройство.md
- Строка: в конце документа
- Добавить:
```
## Безопасность протоколов SAP

### Известные уязвимости (исправлены)
- CVE-2016-2386: DIAG compression vulnerability
- CVE-2020-6287: RFC SYSTEM user vulnerability
- CVE-2022-22536: ICM vulnerability

### Best Practices
1. **Всегда используйте SNC** для критичных соединений
2. **Ограничивайте доступ** через reginfo/secinfo
3. **Мониторьте** подозрительную активность (SM20)
4. **Обновляйте** kernel patches регулярно
5. **Используйте** сетевую сегментацию

### Параметры безопасности
```
# Enforce SNC for DIAG
snc/enable = 1
snc/data_protection/use = 3

# Secure RFC
gw/sec_info = $(DIR_DATA)/secinfo
gw/reg_info = $(DIR_DATA)/reginfo
gw/acl_mode = 1
```
```
- Причина: Отсутствует критически важная информация о безопасности

### Исправление 16: Добавить инструменты анализа
- Файл: ADD - Глава 7 Приложение Протоколы SAP - открытость и внутреннее устройство.md
- Строка: в конце документа
- Добавить:
```
## Инструменты анализа протоколов

### Встроенные SAP
- **SMGW**: Gateway Monitor (RFC трафик)
- **SM59**: RFC Destinations (тестирование)
- **SICF**: ICM Monitor (HTTP/HTTPS)
- **ST05**: SQL/RFC/HTTP Trace

### Внешние инструменты
- **Wireshark**: С плагинами для SAP протоколов
- **SAP Dissector Plugin**: Для анализа DIAG/RFC
- **Nmap**: С NSE скриптами для SAP
- **Burp Suite**: Для анализа HTTP-based протоколов

### Пример использования Wireshark
```
# Фильтр для DIAG трафика
tcp.port == 3200

# Фильтр для RFC
tcp.port == 3300 or tcp.port == 4800
```
```
- Причина: Отсутствует информация об инструментах анализа

### Исправление 17: Добавить примеры конфигурации
- Файл: ADD - Глава 7 Приложение Протоколы SAP - открытость и внутреннее устройство.md
- Строка: для каждого протокола
- Добавить конкретные примеры:
```
### Примеры конфигурации

**DIAG с SNC**:
```
# Profile parameters
snc/identity/as = p:CN=<SID>, O=<Company>, C=<Country>
snc/data_protection/use = 3
snc/data_protection/max = 3
```

**RFC Gateway ACL**:
```
# reginfo example
P TP=* HOST=internal USER=* CANCEL=internal
P TP=/rfctest/* HOST=localhost USER=* 

# secinfo example
P HOST=10.0.0.0/8 USER=* USER-HOST=* TP=*
D HOST=* USER=* USER-HOST=* TP=*
```

**Message Server ACL**:
```
# ms_acl_info
HOST=*.company.com
HOST=10.0.0.0/8
```
```
- Причина: Отсутствуют практические примеры конфигурации

### Исправление 18: Добавить troubleshooting
- Файл: ADD - Глава 7 Приложение Протоколы SAP - открытость и внутреннее устройство.md
- Строка: в конце документа
- Добавить:
```
## Troubleshooting протоколов

### Частые проблемы

**DIAG: "Connection refused"**
- Проверить порт 32NN открыт
- Проверить диспетчер запущен (SM51)
- Проверить параметр rdisp/msserv

**RFC: "RFC_ERROR_SYSTEM_FAILURE"**
- Проверить Gateway (SMGW)
- Проверить secinfo/reginfo
- Проверить трассировку (ST05)

**HTTP/HTTPS: 503 Service Unavailable**
- Проверить ICM статус (SMICM)
- Проверить порты 80NN/443NN
- Проверить сервисы (SICF)

### Полезные команды OS
```bash
# Проверка портов Linux
netstat -tulpn | grep -E "32|33|80"

# Проверка портов Windows  
netstat -an | findstr "32 33 80"

# Тест соединения
telnet <host> 3200
```
```
- Причина: Отсутствует раздел troubleshooting